<!DOCTYPE html>
<html lang="ko"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.1.6 <https://hydejack.com/>
-->







<head>
  






  
    

<title>[Nest.js] Google OAuth2.0 (OIDC) 로그인 구현하기 | NicoDora</title>
<meta name="description" content="Nest.js에서 Google OAuth2.0 (OIDC) 로그인을 구현하는 방법에 대해 알아보겠습니다.
">
<link rel="canonical" href="http://localhost:4000/nestjs/Nest.js-Google-OAuth20-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0/">

  

  



  <meta name="theme-color" content="rgb(25,55,71)">


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="NicoDora">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta name="application-name" content="NicoDora">

<meta name="generator" content="Hydejack v9.1.6" />


<link rel="alternate" href="http://localhost:4000/nestjs/Nest.js-Google-OAuth20-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0/" hreflang="ko">



<link rel="shortcut icon"    href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

<link rel="manifest" href="/assets/site.webmanifest">

<link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">


<link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG">
  <link rel="dns-prefetch" href="/assets/js/search-worker-9.1.6.js" as="worker" id="_hrefSearch">






<script>!function(r,c){"use strict";function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=c.createElement("script"),e=(n.src=e,t&&a(n,"load",t,{once:!0}),c.scripts[0]);return e.parentNode.insertBefore(n,e),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=c.createElement("script");function o(){r._loaded=!0,t&&a(n,"load",t,{once:!0});var e=c.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():a(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){a(c.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
!function(w) {
  w._baseURL = '/';
  w._publicPath = '/assets/js/';
  w._noPushState = false;
  w._noDrawer = false;
  w._noNavbar = false;
  w._noToc = false;
  w._noSearch = false;
  w._search = {
    DATA_URL: '/assets/sitedata.json?no-cache',
    STORAGE_KEY: 'mini-search/',
    INDEX_KEY: 'index--2026-01-15T20:21:50+09:00',
  };
  w._clapButton = true;
}(window);</script>



<!--[if gt IE 8]><!---->

  




<link rel="stylesheet" href="/assets/css/hydejack-9.1.6.css" id="_stylePreload">
<link rel="stylesheet" href="/assets/icomoon/style.css" id="_iconsPreload">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload">



  <style id="_pageStyle">

html{--accent-color: rgb(79,177,186);--accent-color-faded: rgba(79, 177, 186, 0.5);--accent-color-highlight: rgba(79, 177, 186, 0.1);--accent-color-darkened: #409ba3;--theme-color: rgb(25,55,71);--dark-mode-body-bg: hsl(200.8695652174, 5.9895833333%, 17.5%);--dark-mode-border-color: hsl(200.8695652174, 5.9895833333%, 22.5%)}
</style>


<!--<![endif]-->




<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="/assets/js/sidebar-folder.js"></script>


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D9VF7EQWGG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D9VF7EQWGG');
</script>
</head>

<body class="dark-mode no-break-layout">
  
<script>
  window._sunrise = 6;
  window._sunset =  18;
  !function(e,s){var d="light-mode",o="dark-mode",a=(new Date).getHours();"matchMedia"in e&&e.matchMedia("(prefers-color-scheme)")||(e=(a=a<=e._sunrise||a>=e._sunset?o:d)==o?d:o,s.body.classList.add(a),s.body.classList.remove(e))}(window,document);

</script>



<hy-push-state
  id="_pushState"
  replace-selector="#_main"
  link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)"
  script-selector="script"
  duration="500"
  hashchange
>
  
  
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <span class="sr-only">Jump to:</span>
    <div class="nav-btn-bar">
      <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
      <div class="nav-span"></div>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />

  <main
  id="_main"
  class="content layout-post"
  role="main"
>
  <nav id="breadcrumbs" class="screen-only"><ul>
  
  
    <li><a href="/">home</a></li>
    
      <li>
        
          <span>/</span>
          
          
          <a href="/nestjs/">nestjs</a>
        
      </li>
    
      <li>
        
          <span>/</span>
          <span>Nest.js-Google-OAuth20-로그인-구현하기</span>
        
      </li>
    
  
</ul></nav>
  










<article id="post-nestjs-[Nest.js]-Google-OAuth20-로그인-구현하기" class="page post mb6" role="article">
  <header>
    <h1 class="post-title flip-project-title">
      
        [Nest.js] Google OAuth2.0 (OIDC) 로그인 구현하기
      
    </h1>

    <div class="post-date">
      
      <span class="ellipsis mr1">
        <time datetime="2026-01-15T20:03:00+09:00">2026-01-15 20:03</time> in <a href="/nestjs/" class="flip-title">NestJS</a> 
      </span>
      
        
      
    </div>

    
    
      
        <div class="img-wrapper lead aspect-ratio sixteen-nine flip-project-img">
          


<img
  
    src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-vs-oidc.png"
  
  alt="[Nest.js] Google OAuth2.0 (OIDC) 로그인 구현하기"
  
  
  width="864"
  height="486"
  loading="lazy"
/>

        </div>
      
      
    

    



  
    <p class="note-sm" >
      Nest.js에서 Google OAuth2.0 (OIDC) 로그인을 구현하는 방법에 대해 알아보겠습니다.

    </p>
  


  </header>

  
    <ol id="markdown-toc">
  <li><a href="#oauth20과-oidc의-차이점" id="markdown-toc-oauth20과-oidc의-차이점">OAuth2.0과 OIDC의 차이점</a></li>
  <li><a href="#oidc-인증-흐름-이해하기" id="markdown-toc-oidc-인증-흐름-이해하기">OIDC 인증 흐름 이해하기</a></li>
  <li><a href="#google-cloud-console에서-oauth-20-클라이언트-설정하기" id="markdown-toc-google-cloud-console에서-oauth-20-클라이언트-설정하기">Google Cloud Console에서 OAuth 2.0 클라이언트 설정하기</a></li>
  <li><a href="#백엔드-코드-작성하기" id="markdown-toc-백엔드-코드-작성하기">백엔드 코드 작성하기</a>    <ol>
      <li><a href="#get-authgoogle-api-구현하기" id="markdown-toc-get-authgoogle-api-구현하기">GET /auth/google API 구현하기</a></li>
      <li><a href="#state와-nonce의-역할" id="markdown-toc-state와-nonce의-역할">State와 Nonce의 역할</a></li>
      <li><a href="#post-authgoogleauthenticate-api-구현하기" id="markdown-toc-post-authgoogleauthenticate-api-구현하기">POST /auth/google/authenticate API 구현하기</a></li>
    </ol>
  </li>
  <li><a href="#프론트엔드에서-필요한-작업" id="markdown-toc-프론트엔드에서-필요한-작업">프론트엔드에서 필요한 작업</a></li>
  <li><a href="#구글-로그인-테스트하기" id="markdown-toc-구글-로그인-테스트하기">구글 로그인 테스트하기</a></li>
  <li><a href="#마치며" id="markdown-toc-마치며">마치며</a>    <ol>
      <li><a href="#state-값-저장방식-쿠키-vs-서버" id="markdown-toc-state-값-저장방식-쿠키-vs-서버">state 값 저장방식 (쿠키 vs 서버)</a></li>
      <li><a href="#인가-코드-콜백은-어디로-클라이언트-vs-서버" id="markdown-toc-인가-코드-콜백은-어디로-클라이언트-vs-서버">인가 코드 콜백은 어디로? (클라이언트 vs 서버)</a></li>
    </ol>
  </li>
  <li><a href="#참고-자료" id="markdown-toc-참고-자료">참고 자료</a></li>
</ol>

<h2 id="oauth20과-oidc의-차이점">OAuth2.0과 OIDC의 차이점</h2>

<p>OAuth2.0을 사용하여 구글 로그인을 구현하기 전에, 많은 분들이 혼동하는 OAuth2.0과 OIDC(OpenID Connect)의 차이점에 대해 간단히 짚고 넘어가려 합니다.
<br />
<br />
<strong>OAuth2.0</strong>은 권한 부여 프레임워크로, 사용자가 애플리케이션에 특정 리소스에 대한 접근 권한을 부여할 수 있도록 합니다. 반면, <strong>OIDC(OpenID Connect)</strong>는 OAuth2.0 위에 구축된 인증 프로토콜로, 사용자의 신원을 확인하고 인증 정보를 제공하는 데 중점을 둡니다.
<br />
<br /></p>
<ul>
  <li><b>OAuth2.0 - 권한 부여(Authorization)</b>
    <ul>
      <li>사용자가 애플리케이션에 특정 리소스에 대한 접근 권한을 부여.</li>
      <li>예) 사용자가 애플리케이션에 자신의 구글 드라이브 파일에 접근할 수 있는 권한을 부여.</li>
    </ul>
  </li>
  <li><b>OIDC (OpenID Connect) - 인증(Authentication)</b>
    <ul>
      <li>사용자의 신원을 확인하고 인증 정보를 제공.</li>
      <li>예) 사용자가 애플리케이션에 구글 계정으로 로그인.</li>
    </ul>
  </li>
</ul>

<p><br />
몇몇 개발자분들의 글을 보면 ‘OAuth2.0을 사용하여 소셜 로그인을 구현했다’ 라고 하는데 물론 OAuth2.0을 사용하여 로그인을 구현할 수 있지만, OAuth2.0을 사용하여 로그인을 구현하면 아래와 같은 문제가 발생할 수 있습니다.
<br />
<br />
<b>OAuth 인증 시 주요 문제점</b></p>
<ol>
  <li><b>액세스 토큰을 인증 증거로 오해</b>
    <ul>
      <li>액세스 토큰은 보호된 리소스에 접근하기 위한 권한 부여 수단일 뿐, 그 자체로 사용자 인증을 증명하지는 않습니다.<br />
클라이언트는 토큰의 내용을 알 수 없으므로 사용자 정보를 직접 유도하기 어렵습니다.<br />
(쉬운 예시로, 놀이공원에 입장하는 티켓(액세스 토큰)을 통해 놀이공원(리소스 서버)에 들어갈 수는 있지만, 티켓만으로 그 사람이 누구인지(인증)를 알 수 없는 것과 같습니다.)</li>
    </ul>
  </li>
  <li><b>API 접근 성공을 인증으로 간주</b>
    <ul>
      <li>유효한 토큰으로 사용자 정보를 가져올 수 있다고 해서 사용자가 현재 로그인 상태라고 단정할 수 없습니다.<br />
리프레시 토큰이나 권한 위임을 통해 사용자 없이도 토큰 발급이 가능하며, 사용자가 떠난 후에도 토큰은 한동안 유효하기 때문입니다.</li>
    </ul>
  </li>
</ol>

<blockquote>
  <p><a href="https://oauth.net/articles/authentication/#:~:text=Common%20pitfalls%20for%20authentication%20using%20OAuth">OAuth 공식 문서</a>에서 인증에 OAuth를 사용하는 것을 권장하지 않는 이유에 대해 자세히 살펴볼 수 있습니다.</p>
</blockquote>

<p><br />
OAuth2.0과 OIDC 각각 사용자 정보를 얻는 흐름을 간단히 비교해보면 다음과 같습니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-vs-oidc.png" alt="OAuth2.0 vs OIDC" />
<br />
<br />
OIDC의 경우, OAuth2.0의 흐름에 ID 토큰이 추가되어 사용자의 신원을 확인할 수 있도록 합니다. ID 토큰은 JWT(JSON Web Token) 형식으로 발급되며, 사용자의 정보(예: 이메일, 이름 등)를 포함하고 있습니다.
<br />
<br />
ID 토큰을 통해 사용자 정보를 얻을 수 있기 때문에 사용자 정보를 가져오기 위한 별도의 API 호출이 필요하지 않아 네트워크 비용을 줄일 수 있고 더 안전하게 인증을 처리할 수 있습니다.
<br />
<br />
따라서 이번 포스팅에서는 OIDC를 사용하여 구글 로그인을 구현하는 방법에 대해 알아보겠습니다.</p>

<h2 id="oidc-인증-흐름-이해하기">OIDC 인증 흐름 이해하기</h2>

<p>다음은 OIDC 인증 흐름을 나타낸 다이어그램입니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oidc-flow.png" alt="OIDC 인증 흐름" width="400" />
<br />
<br /></p>
<details>
<summary><b>OIDC 인증 흐름 설명 보기</b></summary>
<div>
    <ol>
      <li><b>로그인 요청</b>
        <ul>
          <li>사용자가 ‘구글 로그인’ 버튼을 클릭합니다.</li>
          <li>클라이언트는 서버에 로그인을 요청하고, 서버는 사용자를 구글의 인증 페이지로 리다이렉트(Redirect)시킵니다.\
이때 scope 파라미터에 반드시 <strong><code class="language-plaintext highlighter-rouge">openid</code></strong>를 포함해야 하며, 추가로 <code class="language-plaintext highlighter-rouge">email</code>, <code class="language-plaintext highlighter-rouge">profile</code> 등을 요청합니다.</li>
        </ul>
      </li>
      <li><b>인증 및 권한 승인</b>
        <ul>
          <li>사용자가 구글 로그인 페이지에서 아이디/비밀번호를 입력하고, 서비스가 요청한 정보 제공에 동의합니다.</li>
          <li>구글 인증 서버는 사용자의 신원을 확인하고, 해당 서비스가 사용자의 정보를 가져가는 것에 동의했는지 체크합니다.</li>
        </ul>
      </li>
      <li><b>인가 코드 발급</b>
        <ul>
          <li>구글 인증 서버가 브라우저를 통해 클라이언트의 콜백(Callback) URL로 <strong>인가 코드</strong>를 전달합니다.</li>
          <li>이 코드는 일종의 ‘교환권’으로, 보안을 위해 짧은 시간 동안만 유효합니다.</li>
        </ul>
      </li>
      <li><b>토큰 교환 요청</b>
        <ul>
          <li>클라이언트가 ‘인가 코드’를 들고 토큰을 발급받는 서버(Backend) API에 요청을 보냅니다. 그리고 서버에선 인가 코드를 들고 구글 인증 서버에 실제 토큰을 요청합니다.</li>
          <li>이때 서버는 자신의 <code class="language-plaintext highlighter-rouge">Client ID</code>와 <code class="language-plaintext highlighter-rouge">Client Secret</code>을 함께 보내어 정당한 서버임을 증명합니다.</li>
        </ul>
      </li>
      <li><b>ID 토큰 및 액세스 토큰 발급</b>
        <ul>
          <li>구글 인증 서버는 코드를 검증한 후, <strong>ID 토큰</strong>과 <strong>액세스 토큰</strong>을 서버에 발급합니다.</li>
          <li>(OIDC에서는 유저 정보가 담긴 JWT 형태의 ID 토큰이 함께 돌아옵니다.)</li>
        </ul>
      </li>
      <li><b>ID 토큰 검증 및 유저 정보 획득</b>
        <ul>
          <li>서버는 받은 ID 토큰을 디코딩하여 유저의 이메일, 이름, 고유 식별자(sub) 등을 추출합니다.</li>
          <li>별도의 API 호출(구글 리소스 서버 요청) 없이도 토큰 자체를 검증(Signature 확인)함으로써 유저 정보를 즉시 확인할 수 있습니다. 이 과정에서 네트워크 비용이 절감됩니다.</li>
        </ul>
      </li>
      <li><b>서비스 로그인 완료</b>
        <ul>
          <li>획득한 유저 정보를 DB에 저장하거나 확인한 후, 우리 서비스 전용 토큰(JWT 등)을 발급하여 사용자에게 응답합니다.</li>
          <li>사용자는 최종적으로 서비스에 로그인된 상태가 됩니다.</li>
        </ul>
      </li>
    </ol>
  </div>
</details>
<p><br />
<br />
처음 설명을 보면 이해하기 어려울 수 있기에 <a href="https://developers.google.com/oauthplayground/">Google OAuth Playground</a>에서 직접 OAuth 관련 요청을 시도해보는걸 추천드립니다.
<br />
<br />
사이트에 들어가보면 다음과 같은 화면이 나옵니다.<br />
좌측 패널을 보시면 총 3단계로 나누어져 있습니다.
<br />
<br />
Step 1에서는 다양한 구글 API에 대한 인증 요청을 선택하여 시도해볼 수 있습니다.<br />
Step 2에서는 인가 코드를 교환하여 액세스 토큰을 발급받는 과정을 시도해볼 수 있습니다.<br />
Step 3에서는 발급받은 액세스 토큰을 사용하여 구글 API를 호출해볼 수 있습니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground.png" alt="OAuth Playground" />
<br />
<br /></p>

<p>오른쪽 톱니바퀴를 누르면 설정 창이 나오게 되는데 일단 기본 설정으로 두고 시작하겠습니다. (나중에 커스텀 설정을 통해 내 서비스의 구글 로그인을 테스트 해볼 수 있습니다.)
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-setting.png" alt="OAuth Playground Setting" />
<br />
<br /></p>

<p>Step 1에서 <b>Google OAuth2 API v2</b>를 선택하고 <code class="language-plaintext highlighter-rouge">https://www.googleapis.com/auth/userinfo.email</code>, <code class="language-plaintext highlighter-rouge">https://www.googleapis.com/auth/userinfo.profile</code>, <code class="language-plaintext highlighter-rouge">openid</code> 스코프를 추가합니다.<br />
그리고 <b>Authorize APIs</b> 버튼을 클릭합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-scope.png" alt="OAuth Playground Scope" width="400" />
<br />
<br /></p>

<p>그러면 구글 로그인 페이지로 리다이렉트되며, 로그인을 진행하고 권한을 승인합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-login.png" alt="OAuth Playground Login" />
<br />
<br /></p>

<p>승인 후에는 다시 OAuth Playground로 리다이렉트 되고 인가 코드를 발급받게됩니다.
<br />
<br />
여기까지가 ‘로그인 버튼 클릭’ 부터 ‘인가 코드 발급’까지의 흐름입니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-authorized.png" alt="OAuth Playground Authorized" width="400" />
<br />
<br /></p>

<p>이제 Step 2에서 인가 코드를 교환하여 액세스 토큰을 발급받을 수 있습니다.<br />
<b>Exchange authorization code for tokens</b> 버튼을 클릭합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-exchange.png" alt="OAuth Playground Exchange" />
<br />
<br /></p>

<p>그러면 액세스 토큰, 리프레시 토큰과 함께 <b>ID 토큰</b>도 발급받는 것을 확인할 수 있습니다.<br />
액세스 토큰을 사용하여 Step 3에서 다른 구글 API를 호출해볼 수 있습니다만 지금은 구글 로그인 구현이 목적이기에 Step 3까지 진행하지 않아도 됩니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-tokens.png" alt="OAuth Playground Tokens" />
<br />
<br /></p>

<p>ID 토큰은 JWT 형식으로 되어 있으며, <a href="https://jwt.io/">jwt.io</a>에서 디코딩해보면 다음과 같이 사용자 정보가 포함되어 있는 것을 확인할 수 있습니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-id-token.png" alt="OAuth Playground ID Token" />
<br /></p>

<blockquote>
  <p>구글 ID 토큰의 페이로드에 대한 정보는 <a href="https://developers.google.com/identity/openid-connect/openid-connect?hl=ko#an-id-tokens-payload">ID 토큰의 페이로드</a> 문서를 참고해주세요.</p>
</blockquote>

<p><br />
ID 토큰 디코딩은 실제 서버에서 수행하며, 여기까지가 ‘인가 코드를 가지고 서비스 토큰 발급 요청’부터 ‘ID 토큰을 디코딩하여 사용자 정보 획득’까지의 흐름입니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/oauth-playground-id-token-decoded.png" alt="OAuth Playground ID Token Decoded" width="400" /></p>

<h2 id="google-cloud-console에서-oauth-20-클라이언트-설정하기">Google Cloud Console에서 OAuth 2.0 클라이언트 설정하기</h2>

<p>구글 로그인을 구현하기 위해서는 먼저 <a href="https://console.cloud.google.com/">Google Cloud Console</a>에서 OAuth 2.0 클라이언트를 설정해야 합니다.<br />
Google Cloud Console에 접속한 후, 새 프로젝트를 생성하고 ‘API 및 서비스’ &gt; ‘OAuth 동의 화면’ 메뉴를 클릭합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-oauth-consent-screen.png" alt="Google Cloud Console OAuth Consent Screen" />
<br />
<br /></p>

<p>OAuth 개요에서 ‘시작하기’ 버튼을 클릭하여 프로젝트 구성을 시작합니다.<br />
앱 이름, 사용자 지원 이메일, 개발자 연락처 정보 등을 알맞게 입력하시고 대상 유형은 ‘외부’를 선택합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-oauth-consent-start.png" alt="Google Cloud Console OAuth Consent Start" />
<br />
<br /></p>

<p>프로젝트 구성을 완료한 후, ‘OAuth 클라이언트 만들기’를 클릭하여 OAuth 2.0 클라이언트를 생성합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-create-oauth-client.png" alt="Google Cloud Console Create OAuth Client" />
<br />
<br /></p>

<p>애플리케이션 유형은 ‘웹 애플리케이션’을 선택하고, 이름을 입력합니다.<br />
‘승인된 JavaScript 원본’에는 클라이언트의 도메인을 입력하고, ‘승인된 리디렉션 URI’에는 구글 인증 후 리다이렉트될 클라이언트의 콜백 URL을 입력합니다.<br />
(일단 로컬에서 테스트할 예정이기에 localhost를 사용하였지만, 실제 서비스에서는 배포된 도메인을 사용해야 합니다.)
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-oauth-client-settings.png" alt="Google Cloud Console Create OAuth Client Settings" width="600" />
<br />
<br /></p>

<p>설정을 완료하고 ‘만들기’ 버튼을 클릭하면 클라이언트 ID와 클라이언트 보안 비밀번호가 발급됩니다.<br />
클라이언트 보안 비밀번호는 모달 창을 닫으면 다시 볼 수 없으니 안전한 곳에 보관해주세요!
<br />
<br />
다음으로 ‘데이터 액세스’ 탭으로 이동해서 ‘범위 추가 또는 삭제’ 버튼을 클릭합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-oauth-scopes.png" alt="Google Cloud Console OAuth Scopes" />
<br />
<br /></p>

<p><code class="language-plaintext highlighter-rouge">.../auth/userinfo.email</code>, <code class="language-plaintext highlighter-rouge">.../auth/userinfo.profile</code>, <code class="language-plaintext highlighter-rouge">openid</code> 범위를 선택하고 ‘업데이트’ 버튼을 클릭합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-oauth-add-scopes.png" alt="Google Cloud Console OAuth Add Scopes" />
<br />
<br /></p>

<p>‘민감하지 않는 범위’에 선택한 범위들이 추가되었다면 아래 ‘Save’ 버튼을 클릭하여 저장합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-oauth-scopes-saved.png" alt="Google Cloud Console OAuth Scopes Saved" />
<br />
<br /></p>

<p>이제 ‘대상’ 탭으로 이동하여 ‘Add users’ 버튼을 클릭하고 테스트 사용자로 사용할 구글 계정을 추가합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-cloud-oauth-add-test-users.png" alt="Google Cloud Console OAuth Add Test Users" />
<br />
<br />
이렇게 구글 OAuth 2.0 클라이언트 설정이 완료되었습니다.<br />
이제 Nest.js 환경에서 구글 로그인을 구현해보겠습니다.</p>

<h2 id="백엔드-코드-작성하기">백엔드 코드 작성하기</h2>

<p>코드를 작성하기 전에 OIDC 인증을 위해 백엔드에서 구현해야 하는 기능들을 간단히 정리해보면 아래와 같습니다.</p>

<ol>
  <li><b>클라이언트에서 구글 로그인 요청을 처리하는 API 구현</b> (<code class="language-plaintext highlighter-rouge">GET /auth/google</code>)</li>
  <li><b>클라이언트로부터 인가 코드를 받아 서비스 토큰을 발급하는 API 구현</b> (<code class="language-plaintext highlighter-rouge">POST /auth/google/authenticate</code>)
    <ul>
      <li>인가 코드를 구글 인증 서버에 전달하여 ID 토큰과 액세스 토큰 발급 요청</li>
      <li>구글로부터 받은 ID 토큰을 검증하고 사용자 정보 추출</li>
      <li>추출한 사용자 정보를 바탕으로 서비스 로그인 처리</li>
    </ul>
  </li>
</ol>

<h3 id="get-authgoogle-api-구현하기">GET /auth/google API 구현하기</h3>

<p>아래는 첫번째 기능인 <b>‘클라이언트에서 구글 로그인 요청을 처리하는 API’</b>를 구현한 코드입니다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: "auth.controller.ts"</span>
<span class="c1">// ... import statements ...</span>

<span class="p">@</span><span class="nd">ApiTags</span><span class="p">(</span><span class="dl">"</span><span class="s2">Auth (인증)</span><span class="dl">"</span><span class="p">)</span>
<span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">auth</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">googleAuthService</span><span class="p">:</span> <span class="nx">GoogleAuthService</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">appConfigService</span><span class="p">:</span> <span class="nx">AppConfigService</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// ... other endpoints ...</span>

  <span class="p">@</span><span class="nd">ApiAuth</span><span class="p">.</span><span class="nf">googleLogin</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Get</span><span class="p">(</span><span class="dl">"</span><span class="s2">google</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">HttpCode</span><span class="p">(</span><span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">FOUND</span><span class="p">)</span>
  <span class="nf">googleLogin</span><span class="p">(@</span><span class="nd">Res</span><span class="p">()</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">nonce</span> <span class="p">}:</span> <span class="nx">IGoogleAuthOptions</span> <span class="o">=</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">googleAuthService</span><span class="p">.</span><span class="nf">generateAuthOptions</span><span class="p">();</span>

    <span class="kd">const</span> <span class="nx">cookieOptions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">getCommonCookieOptions</span><span class="p">(</span>
      <span class="nx">COOKIE_MAX_AGE</span><span class="p">.</span><span class="nx">GOOGLE_OAUTH</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="c1">// 쿠키에 state와 nonce 저장</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="nx">COOKIE_NAME</span><span class="p">.</span><span class="nx">GOOGLE_STATE</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">cookieOptions</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="nx">COOKIE_NAME</span><span class="p">.</span><span class="nx">GOOGLE_NONCE</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">cookieOptions</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// ... other endpoints ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>코드를 살펴보면, <code class="language-plaintext highlighter-rouge">GET /auth/google</code> 엔드포인트에서 <code class="language-plaintext highlighter-rouge">GoogleAuthService</code>의 <code class="language-plaintext highlighter-rouge">generateAuthOptions()</code> 메서드를 호출하여 구글 인증 URL과 함께 보안 파라미터인 <code class="language-plaintext highlighter-rouge">state</code>, <code class="language-plaintext highlighter-rouge">nonce</code>를 가져오고 있습니다.<br />
그 후에 <code class="language-plaintext highlighter-rouge">state</code>와 <code class="language-plaintext highlighter-rouge">nonce</code>를 쿠키에 저장한 뒤, 클라이언트를 구글 인증 페이지로 리다이렉트시키고 있습니다.
<br />
<br />
다음으로 <code class="language-plaintext highlighter-rouge">GoogleAuthService</code>의 <code class="language-plaintext highlighter-rouge">generateAuthOptions()</code> 메서드 코드를 살펴보겠습니다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: "google-auth.service.ts"</span>
<span class="c1">// ... import statements ...</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nc">GoogleAuthService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">googleClient</span><span class="p">:</span> <span class="nx">OAuth2Client</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Logger</span><span class="p">(</span><span class="nx">GoogleAuthService</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

  <span class="nf">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">appConfigService</span><span class="p">:</span> <span class="nx">AppConfigService</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">userService</span><span class="p">:</span> <span class="nx">UserService</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">Inject</span><span class="p">(</span><span class="nx">AUTH_TOKENS</span><span class="p">.</span><span class="nx">ITokenService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">tokenService</span><span class="p">:</span> <span class="nx">ITokenService</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">googleClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OAuth2Client</span><span class="p">({</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleClientId</span><span class="p">,</span>
      <span class="na">clientSecret</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleClientSecret</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleRedirectUri</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="cm">/**
   * 구글 인증 URL 생성 및 보안 파라미터(state, nonce) 발급
   */</span>
  <span class="nf">generateAuthOptions</span><span class="p">():</span> <span class="nx">IGoogleAuthOptions</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">구글 인증 URL 생성을 시작합니다.</span><span class="dl">"</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">rootUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://accounts.google.com/o/oauth2/v2/auth</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nf">nanoid</span><span class="p">(</span><span class="nx">STATE_LENGTH</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">nonce</span> <span class="o">=</span> <span class="nf">nanoid</span><span class="p">(</span><span class="nx">NONCE_LENGTH</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">client_id</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleClientId</span><span class="p">,</span>
      <span class="na">redirect_uri</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleRedirectUri</span><span class="p">,</span>
      <span class="na">response_type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">scope</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">openid</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">profile</span><span class="dl">"</span><span class="p">].</span><span class="nf">join</span><span class="p">(</span><span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">),</span>
      <span class="na">access_type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">offline</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">state</span><span class="p">,</span>
      <span class="nx">nonce</span><span class="p">,</span>
      <span class="na">prompt</span><span class="p">:</span> <span class="dl">"</span><span class="s2">select_account</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">rootUrl</span><span class="p">}</span><span class="s2">?</span><span class="p">${</span><span class="k">new</span> <span class="nc">URLSearchParams</span><span class="p">(</span><span class="nx">options</span><span class="p">).</span><span class="nf">toString</span><span class="p">()}</span><span class="s2">`</span><span class="p">,</span>
      <span class="nx">state</span><span class="p">,</span>
      <span class="nx">nonce</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="c1">// ... other methods ...</span>
<span class="p">}</span>
</code></pre></div></div>
<blockquote>
  <p>인증 URL Parameter에 대한 자세한 내용은 <a href="https://developers.google.com/identity/openid-connect/openid-connect?hl=ko#authenticationuriparameters">여기</a>를 참고해주세요.</p>
</blockquote>

<p><br />
<code class="language-plaintext highlighter-rouge">nanoid</code> 라이브러리를 사용하여 <code class="language-plaintext highlighter-rouge">state</code>와 <code class="language-plaintext highlighter-rouge">nonce</code>를 생성하고 있는데 각각 어떤 역할을 하는지 간단히 설명드리겠습니다.</p>

<h3 id="state와-nonce의-역할">State와 Nonce의 역할</h3>

<ul>
  <li><b>State</b>
    <ul>
      <li>CSRF(Cross-Site Request Forgery) 공격을 방지하기 위한 보안 토큰입니다.</li>
      <li>클라이언트가 구글 로그인 요청을 서버로 보낼 때 생성하여 클라이언트에 전송하고, 구글 인증 서버는 이 값을 포함시켜 응답합니다.</li>
      <li>클라이언트가 이후에 서버에 서비스 토큰을 요청할 때, 서버는 <code class="language-plaintext highlighter-rouge">state</code> 값이 이전에 클라이언트에게 응답으로 보낸 값과 일치하는지 확인하여 요청의 정당성을 검증합니다.</li>
    </ul>
  </li>
  <li><b>Nonce</b>
    <ul>
      <li>재전송 공격(Replay Attack)을 방지하기 위한 임의의 값입니다.</li>
      <li>클라이언트가 구글 로그인 요청을 서버로 보낼 때 생성하여 클라이언트에 전송하고, 구글 인증 서버는 ID 토큰에 이 값을 포함시켜 응답합니다.</li>
      <li>서버는 ID 토큰에서 받은 <code class="language-plaintext highlighter-rouge">nonce</code> 값이 이전에 클라이언트에게 응답으로 보낸 값과 일치하는지 확인하여 토큰의 유효성을 검증합니다.</li>
    </ul>
  </li>
</ul>

<p>즉, <code class="language-plaintext highlighter-rouge">state</code>는 클라이언트의 요청이 위변조되지 않았는지 검증하는 역할을 하고, <code class="language-plaintext highlighter-rouge">nonce</code>는 ID 토큰이 변조되지 않았는지 검증하는 역할을 합니다.
<br />
<br />
위 코드를 정리해보면 <code class="language-plaintext highlighter-rouge">GET /auth/google</code> 엔드포인트에서 구글 인증 URL과 함께 <code class="language-plaintext highlighter-rouge">state</code>, <code class="language-plaintext highlighter-rouge">nonce</code>를 생성하여 클라이언트를 구글 인증 페이지로 리다이렉트시키는 기능을 구현한 것입니다.</p>

<h3 id="post-authgoogleauthenticate-api-구현하기">POST /auth/google/authenticate API 구현하기</h3>

<p>다음은 두번째 기능인 <b>‘클라이언트로부터 인가 코드를 받아 서비스 토큰을 발급하는 API’</b>를 구현한 코드입니다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: "auth.controller.ts"</span>
<span class="c1">// ... import statements ...</span>

<span class="p">@</span><span class="nd">ApiTags</span><span class="p">(</span><span class="dl">"</span><span class="s2">Auth (인증)</span><span class="dl">"</span><span class="p">)</span>
<span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">auth</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">googleAuthService</span><span class="p">:</span> <span class="nx">GoogleAuthService</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">appConfigService</span><span class="p">:</span> <span class="nx">AppConfigService</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// ... other endpoints ...</span>

  <span class="p">@</span><span class="nd">ApiAuth</span><span class="p">.</span><span class="nf">googleAuthenticate</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Post</span><span class="p">(</span><span class="dl">"</span><span class="s2">google/authenticate</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">HttpCode</span><span class="p">(</span><span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">OK</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">ResponseMessage</span><span class="p">(</span><span class="dl">"</span><span class="s2">구글 로그인에 성공하였습니다.</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">async</span> <span class="nf">googleAuthenticate</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">Body</span><span class="p">(</span><span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">)</span> <span class="nx">code</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">Body</span><span class="p">(</span><span class="dl">"</span><span class="s2">state</span><span class="dl">"</span><span class="p">)</span> <span class="nx">requestState</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">Req</span><span class="p">()</span> <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">Res</span><span class="p">({</span> <span class="na">passthrough</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">AccessTokenResponseDto</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">code</span> <span class="o">||</span> <span class="o">!</span><span class="nx">requestState</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">필수 인증 파라미터(code, state)가 누락되었습니다.</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">savedState</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">COOKIE_NAME</span><span class="p">.</span><span class="nx">GOOGLE_STATE</span><span class="p">];</span>
    <span class="kd">const</span> <span class="nx">savedNonce</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">COOKIE_NAME</span><span class="p">.</span><span class="nx">GOOGLE_NONCE</span><span class="p">];</span>

    <span class="kd">const</span> <span class="na">params</span><span class="p">:</span> <span class="nx">IHandleGoogleLoginParams</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">code</span><span class="p">,</span>
      <span class="nx">savedState</span><span class="p">,</span>
      <span class="nx">requestState</span><span class="p">,</span>
      <span class="nx">savedNonce</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span> <span class="p">}</span> <span class="o">=</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">googleAuthService</span><span class="p">.</span><span class="nf">handleGoogleLogin</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">clearCookie</span><span class="p">(</span><span class="nx">COOKIE_NAME</span><span class="p">.</span><span class="nx">GOOGLE_STATE</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">clearCookie</span><span class="p">(</span><span class="nx">COOKIE_NAME</span><span class="p">.</span><span class="nx">GOOGLE_NONCE</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span>
      <span class="nx">COOKIE_NAME</span><span class="p">.</span><span class="nx">REFRESH_TOKEN</span><span class="p">,</span>
      <span class="nx">refreshToken</span><span class="p">,</span>
      <span class="k">this</span><span class="p">.</span><span class="nf">getCommonCookieOptions</span><span class="p">(</span><span class="nx">COOKIE_MAX_AGE</span><span class="p">.</span><span class="nx">REFRESH_TOKEN</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span> <span class="nx">accessToken</span> <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">POST /auth/google/authenticate</code>에선 클라이언트 Body로 인가 코드(<code class="language-plaintext highlighter-rouge">code</code>)와 <code class="language-plaintext highlighter-rouge">requestState</code>, 쿠키로 <code class="language-plaintext highlighter-rouge">savedState</code>와 <code class="language-plaintext highlighter-rouge">savedNonce</code> 값을 받아 <code class="language-plaintext highlighter-rouge">GoogleAuthService</code>의 <code class="language-plaintext highlighter-rouge">handleGoogleLogin()</code> 메서드를 호출하여 서비스 토큰을 생성하고 있습니다.
<br />
<br />
<code class="language-plaintext highlighter-rouge">GoogleAuthService</code>의 <code class="language-plaintext highlighter-rouge">handleGoogleLogin()</code> 메서드에선 어떻게 서비스 토큰을 만드는지 살펴보겠습니다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// File: "google-auth.service.ts"</span>
<span class="c1">// ... import statements ...</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nc">GoogleAuthService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">googleClient</span><span class="p">:</span> <span class="nx">OAuth2Client</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Logger</span><span class="p">(</span><span class="nx">GoogleAuthService</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

  <span class="nf">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">appConfigService</span><span class="p">:</span> <span class="nx">AppConfigService</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">userService</span><span class="p">:</span> <span class="nx">UserService</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">Inject</span><span class="p">(</span><span class="nx">AUTH_TOKENS</span><span class="p">.</span><span class="nx">ITokenService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">tokenService</span><span class="p">:</span> <span class="nx">ITokenService</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">googleClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OAuth2Client</span><span class="p">({</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleClientId</span><span class="p">,</span>
      <span class="na">clientSecret</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleClientSecret</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleRedirectUri</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// ... other methods ...</span>

  <span class="cm">/**
   * 콜백 처리: 구글 인가 코드를 우리 서비스의 토큰으로 교환
   */</span>
  <span class="k">async</span> <span class="nf">handleGoogleLogin</span><span class="p">(</span>
    <span class="nx">params</span><span class="p">:</span> <span class="nx">IHandleGoogleLoginParams</span><span class="p">,</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">LoginResponseDto</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">savedState</span><span class="p">,</span> <span class="nx">requestState</span><span class="p">,</span> <span class="nx">savedNonce</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">구글 로그인을 처리합니다.</span><span class="dl">"</span><span class="p">);</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="dl">"</span><span class="s2">인증 코드가 없습니다.</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">savedState</span> <span class="o">||</span> <span class="o">!</span><span class="nx">savedNonce</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">로그인 세션이 만료되었습니다. 다시 시도해주세요.</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// A. State 검증 (CSRF 방지)</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">savedState</span> <span class="o">!==</span> <span class="nx">requestState</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="dl">"</span><span class="s2">유효하지 않은 인증 상태(state)입니다.</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// B. 구글 토큰 발급 (ID Token 포함)</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">id_token</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">exchangeCodeForTokens</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">id_token</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="dl">"</span><span class="s2">구글 ID 토큰이 발급되지 않았습니다.</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// C. ID Token 검증 및 nonce 확인 (재전송 공격 방지)</span>
    <span class="kd">const</span> <span class="nx">googlePayload</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">verifyGoogleIdToken</span><span class="p">(</span><span class="nx">id_token</span><span class="p">);</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">googlePayload</span><span class="p">.</span><span class="nx">nonce</span> <span class="o">!==</span> <span class="nx">savedNonce</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">ID 토큰 보안 검증(nonce)에 실패했습니다.</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">googlePayload</span><span class="p">.</span><span class="nx">email_verified</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">구글 이메일 인증이 완료되지 않았습니다.</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// D. 우리 서비스 유저 처리 (회원가입 또는 로그인)</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nf">createSocialUser</span><span class="p">({</span>
      <span class="na">email</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">nickname</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="na">socialId</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span>
      <span class="na">profileImageUrl</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">picture</span><span class="p">,</span>
      <span class="na">provider</span><span class="p">:</span> <span class="dl">"</span><span class="s2">GOOGLE</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">sub</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nf">getId</span><span class="p">().</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nf">getEmail</span><span class="p">().</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">role</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nf">getRole</span><span class="p">().</span><span class="nf">getValue</span><span class="p">();</span>

    <span class="kd">const</span> <span class="na">accessTokenPayload</span><span class="p">:</span> <span class="nx">IAccessTokenPayload</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">sub</span><span class="p">,</span>
      <span class="nx">email</span><span class="p">,</span>
      <span class="nx">role</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">refreshTokenPayload</span><span class="p">:</span> <span class="nx">IRefreshTokenPayload</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">sub</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c1">// E. 자체 서비스 토큰 발급</span>
    <span class="kd">const</span> <span class="p">[</span><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">all</span><span class="p">([</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">tokenService</span><span class="p">.</span><span class="nf">generateAccessToken</span><span class="p">(</span><span class="nx">accessTokenPayload</span><span class="p">),</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">tokenService</span><span class="p">.</span><span class="nf">generateRefreshToken</span><span class="p">(</span><span class="nx">refreshTokenPayload</span><span class="p">),</span>
    <span class="p">]);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`구글 로그인이 성공적으로 완료되었습니다: </span><span class="p">${</span><span class="nx">email</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nc">LoginResponseDto</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**
   * 구글 서버에 Code를 주고 ID Token을 받아옴
   */</span>
  <span class="k">private</span> <span class="k">async</span> <span class="nf">exchangeCodeForTokens</span><span class="p">(</span><span class="nx">code</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Credentials</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">구글 서버와 인가 코드를 토큰으로 교환합니다.</span><span class="dl">"</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">tokens</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">googleClient</span><span class="p">.</span><span class="nf">getToken</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">errorMessage</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">구글 토큰 발급에 실패했습니다.</span><span class="dl">"</span><span class="p">;</span>

      <span class="k">if </span><span class="p">(</span><span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// google-auth-library는 에러 발생 시 response data를 포함할 수 있습니다.</span>
        <span class="kd">const</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">error</span> <span class="k">as</span> <span class="kr">any</span><span class="p">).</span><span class="nx">response</span><span class="p">?.</span><span class="nx">data</span><span class="p">;</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">responseData</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span>
            <span class="s2">`구글 토큰 교환 실패 상세: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">responseData</span><span class="p">)}</span><span class="s2">`</span><span class="p">,</span>
          <span class="p">);</span>
          <span class="nx">errorMessage</span> <span class="o">=</span> <span class="s2">`구글 토큰 교환 실패: </span><span class="p">${</span><span class="nx">responseData</span><span class="p">.</span><span class="nx">error_description</span> <span class="o">||</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">errorMessage</span> <span class="o">=</span> <span class="s2">`구글 토큰 교환 실패: </span><span class="p">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/**
   * 구글 ID 토큰 검증
   */</span>
  <span class="k">private</span> <span class="k">async</span> <span class="nf">verifyGoogleIdToken</span><span class="p">(</span><span class="nx">idToken</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TokenPayload</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">구글 ID 토큰을 검증합니다.</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">ticket</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">googleClient</span><span class="p">.</span><span class="nf">verifyIdToken</span><span class="p">({</span>
        <span class="nx">idToken</span><span class="p">,</span>
        <span class="na">audience</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">appConfigService</span><span class="p">.</span><span class="nx">googleClientId</span><span class="p">,</span>
      <span class="p">});</span>

      <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">ticket</span><span class="p">.</span><span class="nf">getPayload</span><span class="p">();</span>
      <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">ID 토큰 페이로드가 비어있습니다.</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">payload</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span>
        <span class="s2">`구글 ID 토큰 검증 실패: </span><span class="p">${</span><span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span> <span class="p">?</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">알 수 없는 오류</span><span class="dl">"</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>구글 ID 토큰 검증 단계는 <a href="https://developers.google.com/identity/openid-connect/openid-connect?hl=ko#validatinganidtoken">ID 토큰 검증 가이드</a>를 참고하시면 되며, 필자는 <a href="https://developers.google.com/identity/gsi/web/guides/verify-google-id-token?hl=ko#using-a-google-api-client-library">Google API 클라이언트 라이브러리</a>를 사용하여 구현했습니다.</p>
</blockquote>

<p><br />
이제 코드를 단계별로 살펴보겠습니다.
<br />
<br />
<b>A. State 검증</b></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// A. State 검증 (CSRF 방지)</span>
<span class="k">if </span><span class="p">(</span><span class="nx">savedState</span> <span class="o">!==</span> <span class="nx">requestState</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="dl">"</span><span class="s2">유효하지 않은 인증 상태(state)입니다.</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>먼저 <code class="language-plaintext highlighter-rouge">GET /auth/google</code> 엔드포인트에서 쿠키에 저장했던 <code class="language-plaintext highlighter-rouge">savedState</code> 값과 클라이언트로부터 받은 <code class="language-plaintext highlighter-rouge">requestState</code> 값을 비교합니다. 만약 두 값이 일치하지 않는다면 CSRF 공격일 가능성이 있으므로 예외를 던집니다.
<br />
<br />
<b>B. 구글 ID 토큰 발급</b></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// B. 구글 토큰 발급 (ID Token 포함)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">id_token</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">exchangeCodeForTokens</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>

<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">id_token</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="dl">"</span><span class="s2">구글 ID 토큰이 발급되지 않았습니다.</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">exchangeCodeForTokens()</code> 메서드를 호출하여 구글 인증 서버에 인가 코드를 전달하고 ID 토큰과 액세스 토큰을 발급받습니다.
<br />
<br />
<b>C. ID 토큰 검증 및 nonce 확인</b></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// C. ID Token 검증 및 nonce 확인 (재전송 공격 방지)</span>
<span class="kd">const</span> <span class="nx">googlePayload</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">verifyGoogleIdToken</span><span class="p">(</span><span class="nx">id_token</span><span class="p">);</span>

<span class="k">if </span><span class="p">(</span><span class="nx">googlePayload</span><span class="p">.</span><span class="nx">nonce</span> <span class="o">!==</span> <span class="nx">savedNonce</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">ID 토큰 보안 검증(nonce)에 실패했습니다.</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">googlePayload</span><span class="p">.</span><span class="nx">email_verified</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnauthorizedException</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">구글 이메일 인증이 완료되지 않았습니다.</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">verifyGoogleIdToken()</code> 메서드를 호출하여 구글로부터 받은 ID 토큰을 검증하고, 토큰의 페이로드를 가져옵니다.<br />
그 후에 페이로드에 포함된 <code class="language-plaintext highlighter-rouge">nonce</code> 값과 쿠키에 저장했던 <code class="language-plaintext highlighter-rouge">savedNonce</code> 값을 비교하여 재전송 공격을 방지합니다.<br />
또한, 구글 이메일 인증이 완료되었는지도 확인합니다.
<br />
<br />
<b>D. 우리 서비스 유저 처리</b></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// D. 우리 서비스 유저 처리 (회원가입 또는 로그인)</span>
<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nf">createSocialUser</span><span class="p">({</span>
  <span class="na">email</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
  <span class="na">nickname</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
  <span class="na">socialId</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span>
  <span class="na">profileImageUrl</span><span class="p">:</span> <span class="nx">googlePayload</span><span class="p">.</span><span class="nx">picture</span><span class="p">,</span>
  <span class="na">provider</span><span class="p">:</span> <span class="dl">"</span><span class="s2">GOOGLE</span><span class="dl">"</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div>

<p>ID 토큰에서 추출한 사용자 정보를 바탕으로 <code class="language-plaintext highlighter-rouge">UserService</code>의 <code class="language-plaintext highlighter-rouge">createSocialUser()</code> 메서드를 호출하여 우리 서비스의 유저를 생성하거나 기존 유저를 조회합니다.
<br />
<br />
<b>E. 자체 서비스 토큰 발급</b></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// E. 자체 서비스 토큰 발급</span>
<span class="kd">const</span> <span class="p">[</span><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">all</span><span class="p">([</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">tokenService</span><span class="p">.</span><span class="nf">generateAccessToken</span><span class="p">(</span><span class="nx">accessTokenPayload</span><span class="p">),</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">tokenService</span><span class="p">.</span><span class="nf">generateRefreshToken</span><span class="p">(</span><span class="nx">refreshTokenPayload</span><span class="p">),</span>
<span class="p">]);</span>

<span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`구글 로그인이 성공적으로 완료되었습니다: </span><span class="p">${</span><span class="nx">email</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

<span class="k">return</span> <span class="k">new</span> <span class="nc">LoginResponseDto</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span><span class="p">);</span>
</code></pre></div></div>

<p>마지막으로 자체 서비스 토큰(JWT)을 발급한 후 반환합니다.</p>

<h2 id="프론트엔드에서-필요한-작업">프론트엔드에서 필요한 작업</h2>

<p>저는 이번 포스팅에서 백엔드 구현에 집중했기에 프론트엔드 코드는 다루지 않았습니다.<br />
혹여나 필요한 분들을 위해 간단히 프론트엔드에서 필요한 작업에 대해서 말해보자면 아래와 같습니다.
<br /></p>
<ol>
  <li>구글 로그인 버튼을 클릭했을 때 <code class="language-plaintext highlighter-rouge">GET /auth/google</code> API로 요청을 보내는 로직이 필요합니다.</li>
  <li>구글 인증이 완료된 후 콜백 URL(http://localhost:5173/google-callback)에서 인가 코드와 <code class="language-plaintext highlighter-rouge">state</code> 값을 받아 <code class="language-plaintext highlighter-rouge">POST /auth/google/authenticate</code> API로 전달하는 작업이 필요합니다.</li>
</ol>

<h2 id="구글-로그인-테스트하기">구글 로그인 테스트하기</h2>

<p>이제 모든 구현이 완료되었으니 제가 만든 서비스에서 구글 로그인을 테스트해보겠습니다.<br />
로그인 페이지에서 구글 로그인 버튼을 클릭합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-login-button.png" alt="Google Login Button" />
<br />
<br />
구글 로그인 버튼을 클릭하면 <code class="language-plaintext highlighter-rouge">GET /auth/google</code> API가 호출되고, 클라이언트는 구글 인증 페이지로 리다이렉트됩니다.
<br />
<br />
구글 로그인 페이지에서 원하는 계정을 선택하고 권한을 승인합니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-grant-permission.png" alt="Google Grant Permission" />
<br />
<br />
승인 후에는 다시 클라이언트의 콜백 URL로 리다이렉트되고, 인가 코드와 <code class="language-plaintext highlighter-rouge">state</code> 값이 포함되어 있을겁니다.<br />
프론트엔드에선 이 값을 추출하여 <code class="language-plaintext highlighter-rouge">POST /auth/google/authenticate</code> API로 전달합니다.<br />
그 결과 응답값으로 서비스 토큰(액세스 토큰, 리프레시 토큰)을 받게 되고, 이를 통해 서비스에 로그인된 상태가 됩니다.
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/nestjs/2026-01-15-Nestjs-Google-OAuth20-로그인-구현하기/google-login-success.png" alt="Google Login Success" /></p>

<h2 id="마치며">마치며</h2>

<p>이렇게 해서 Nest.js 환경에서 OIDC를 사용하여 구글 로그인 구현을 완료했습니다.</p>

<p class="note">전체 코드가 궁금하신 분들은 <a href="https://github.com/NicoDora/sift-backend/blob/develop/src/modules/auth/presentation/auth.controller.ts">여기</a>를 참고해주세요.</p>

<p>아래부터는 제가 구글 로그인을 구현하면서 마주한 문제들과 그에 대한 생각을 정리해 보았으니 로그인 구현을 마치셨다면 한번쯤 읽어보시면 좋을 것 같습니다.</p>

<p>그럼 다음 포스트에서 뵙겠습니다! 뾰로롱~
<br />
<br />
<img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/frieren1.gif" width="300" height="300" alt="프리렌 움짤1" /></p>

<h3 id="state-값-저장방식-쿠키-vs-서버">state 값 저장방식 (쿠키 vs 서버)</h3>

<p><code class="language-plaintext highlighter-rouge">state</code> 값을 저장하는 이유는 CSRF 공격을 방지하기 위함인데, 제가 구현한 방식을 보다보면 이런 생각이 들 수 있습니다.<br />
“<code class="language-plaintext highlighter-rouge">state</code> 값을 클라이언트 쿠키에 저장하지 않고, 서버 세션이나 인메모리 캐시(Redis 등)에 저장하는게 더 안전하지 않을까?”<br />
서버 세션이나 인메모리 캐시에 저장하는 방법이 보안상 더 안전할 수 있지만, 서버에 저장하게 된다면 다음과 같은 문제점이 발생할 수 있습니다.
<br />
<br />
먼저 서버에서 <code class="language-plaintext highlighter-rouge">state</code> 값을 관리해야 하므로 추가적인 저장소가 필요합니다. 그리고 로그인이 한번의 API 요청으로 완료되는게 아니라 두 단계로 나누어지기 때문에, 후에 토큰 발급 요청을 보내는 클라이언트가 이전에 로그인 요청을 보낸 클라이언트와 동일한지 확인하기 위해 세션 식별자나 기타 식별자를 함께 관리해야 합니다.
<br />
<br />
세션 식별자는 쿠키에 저장되기 때문에 결국 쿠키를 사용하여 클라이언트에 정보를 저장하게 되고, 서버에서 세션을 관리해야 하는 추가적인 복잡성이 발생합니다. 그리고 OAuth 인증 흐름에서는 stateless(무상태성)를 유지하는 것이 권장되기 때문에, 서버에서 상태를 관리하는 것은 이러한 원칙에 어긋날 수 있습니다. (서버가 여러 대일 경우 상태 동기화 작업도 해줘야 합니다.)
<br />
<br />
따라서 <code class="language-plaintext highlighter-rouge">state</code> 값을 클라이언트 쿠키에 저장하는 방식이 더 간단하게 구현할 수 있고 OAuth의 무상태성 원칙에도 부합한다고 생각하여 쿠키에 저장하는 방식을 선택했습니다.</p>

<h3 id="인가-코드-콜백은-어디로-클라이언트-vs-서버">인가 코드 콜백은 어디로? (클라이언트 vs 서버)</h3>

<p>대부분의 글이나 예제를 살펴보면 인가 코드 콜백 URL을 서버로 지정하는 경우가 많습니다.<br />
실제로 구글의 <a href="https://developers.google.com/identity/openid-connect/openid-connect?hl=ko#server-flow">OIDC 서버 흐름</a> 문서에서도 콜백 URL을 서버로 지정하고 있습니다.
<br />
<br />
그러나 이렇게 콜백 URL을 서버로 지정하게 되면 서버에서 다시 클라이언트로 리다이렉트 시켜주는 추가적인 작업이 필요합니다.<br />
즉, 302 응답을 보내게 된다는 것인데 브라우저는 302 응답을 받으면 <code class="language-plaintext highlighter-rouge">Body</code>를 읽기 전에 <code class="language-plaintext highlighter-rouge">Location</code> 헤더에 적힌 주소로 즉시 이동(Redirect)해 버립니다.
<br />
<br />
쿠키로 서비스 토큰을 전달할 수 있지만 저희 서비스에선 액세스 토큰은 <code class="language-plaintext highlighter-rouge">localStorage</code>에, 리프레시 토큰은 쿠키에 저장하는 방식을 사용하고 싶었기 때문에 어떤 방법을 써야할지 고민했습니다.
<br />
<br />
가장 간단한 방법으론 액세스 토큰을 URL 파라미터에 포함시키는 방법이 있겠지만, URL에 민감한 정보를 담는 것은 보안상 좋지 않기에 이 방법은 제외했고, 또 다른 방법으로는 액세스 토큰도 <code class="language-plaintext highlighter-rouge">httpOnly</code> 옵션을 끈 쿠키에 임시 저장하여 클라이언트에서 이를 읽은 뒤 즉시 삭제하는 방법을 생각해봤습니다. 그러나 이 역시 보안상 좋지 않고 클라이언트에서 불필요한 작업이 추가된다는 단점이 있었습니다.
<br />
<br />
그래서 저는 인가 코드 콜백 URL을 클라이언트로 지정하는 방식을 선택했습니다.<br />
중간에 클라이언트가 요청을 보내는 작업이 추가되긴 하지만, 제가 원하는대로 <code class="language-plaintext highlighter-rouge">Body</code>에 액세스 토큰을 실어 보낼 수 있고, 실제 구글과 통신하여 토큰을 바꾸고 유효성을 검증하는 모든 권한과 로직은 서버에 있기 때문에 서버 주도 방식 (Server-side Flow)을 유지할 수 있었기 때문입니다.</p>

<h2 id="참고-자료">참고 자료</h2>

<ul>
  <li><a href="https://developers.google.com/identity/openid-connect/openid-connect?hl=ko">OpenID Connect</a></li>
  <li><a href="https://oauth.net/articles/authentication/">User Authentication with OAuth 2.0</a></li>
  <li><a href="https://developers.google.com/oauthplayground/">Google OAuth 2.0 Playground</a></li>
  <li><a href="https://openid.net/specs/openid-connect-core-1_0-final.html#StandardClaims">OpenID Connect Core 1.0</a></li>
  <li><a href="https://developers.google.com/identity/openid-connect/openid-connect?hl=ko#an-id-tokens-payload">ID 토큰의 페이로드</a></li>
  <li><a href="https://developers.google.com/identity/openid-connect/openid-connect?hl=ko#validatinganidtoken">ID 토큰 검증</a></li>
  <li><a href="https://developers.google.com/identity/gsi/web/guides/verify-google-id-token?hl=ko">서버 측에서 Google ID 토큰 확인</a></li>
</ul>

  
</article>



  <hr class="dingbat related mb6" />


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D9VF7EQWGG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D9VF7EQWGG');
</script>




  
     



  

  
  

  
    


  <aside class="related mb4" role="complementary">  <h2 class="hr-bottom">Related Posts</h2>  <ul class="related-posts">                  <li class="h4">  <a href="/nestjs/Nest.js-websocket-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EB%A1%9C-ack-%EB%B3%B4%EB%82%B4%EA%B8%B0/" class="flip-title"><span>[Nest.js] websocket 클라이언트로 ack 보내기</span></a>  <time class="faded fine" datetime="2025-03-24T20:00:00+09:00">2025-03-24 20:00</time></li>                        <li class="h4">  <a href="/github/GitHub-Actions%EB%A1%9C-CICD-%EA%B5%AC%EC%B6%95%ED%95%98%EA%B8%B0/" class="flip-title"><span>GitHub Actions로 CI/CD 구축하기</span></a>  <time class="faded fine" datetime="2025-03-18T18:03:00+09:00">2025-03-18 18:03</time></li>                        <li class="h4">  <a href="/aws/AWS-EC2%EC%97%90%EC%84%9C-Nginx%EC%99%80-Certbot%EC%9C%BC%EB%A1%9C-Lets-encrypt-SSL-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EB%B0%9C%EA%B8%89%ED%95%98%EA%B8%B0/" class="flip-title"><span>AWS EC2에서 Nginx와 Certbot으로 Let's encrypt SSL 인증서 발급하기</span></a>  <time class="faded fine" datetime="2025-03-07T14:31:00+09:00">2025-03-07 14:31</time></li>            </ul></aside>

  

  
  

  
    
<aside class="comments related" role="complementary">
  <h2 class="hr-bottom">Comments</h2>
  <!-- 
 -->
<script src="https://giscus.app/client.js"
        data-repo="NicoDora/NicoDora.github.io"
        data-repo-id="R_kgDOLeHHqA"
        data-category="Comments"
        data-category-id="DIC_kwDOLeHHqM4CeGWL"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="dark_dimmed"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</aside>


  

  
<footer class="content" role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2026 NicoDora. All rights reserved.
</small></p>
  
  
    <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">9.1.6</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

  <hy-drawer
  id="_drawer"
  class=""
  side="left"
  threshold="10"
  noscroll
  
>
  <header id="_sidebar" class="sidebar" role="banner">
    




<div class="sidebar-bg sidebar-overlay" style="background-color:rgb(25,55,71);background-image:url(https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
  <div class="sidebar-about">
    
      <a class="no-hover" href="/" tabindex="-1">
        <img src="https://cdn.jsdelivr.net/gh/NicoDora/nicodora.github.io/assets/img/logo.png" class="avatar" alt="NicoDora" width="120" height="120" loading="lazy" />
      </a>
    
    <a class="sidebar-title" href="/"><h2 class="h2">NicoDora</h2></a>
    
    
      <p class="">
        keep moving

      </p>
    
  </div>

  <nav class="sidebar-nav heading" role="navigation">
    <span class="sr-only">Navigation:</span>
<ul>
  
    
      
      <li>
        <a
          id="_drawer--opened"
          href="/"
          class="sidebar-nav-item "
          
        >
          Home
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/aws/"
          class="sidebar-nav-item "
          
        >
          AWS
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/docker/"
          class="sidebar-nav-item "
          
        >
          Docker
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/github/"
          class="sidebar-nav-item "
          
        >
          GitHub
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/nestjs/"
          class="sidebar-nav-item "
          
        >
          NestJS
        </a>
      </li>
    
  
</ul>

  </nav>

  
  <div class="sidebar-social">
    <span class="sr-only">Social</span>
<ul>
  
    
    

    
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/NicoDora" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    

    
    
  
</ul>

  </div>
</div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

</hy-push-state>


  <!--[if gt IE 10]><!---->
  <script nomodule>!function(){var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())}();
</script>
  <script src="/assets/js/hydejack-9.1.6.js" type="module"></script>
  <script src="/assets/js/LEGACY-hydejack-9.1.6.js" nomodule defer></script>
  

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      if (navigator.CookiesOK) {
        ga('create', 'G-D9VF7EQWGG', 'auto');
      } else if (d.cookie.indexOf("hy--cookies-ok=true") > -1) {
        ga('create', 'G-D9VF7EQWGG', {
          'storage': 'none',
          'clientId': localStorage ? localStorage.getItem('ga--client-id') : undefined
        });
      } else {
        ga('create', 'G-D9VF7EQWGG', {
          'storage': 'none'
        });
        ga('set', 'forceSSL', true);
        ga('set', 'anonymizeIp', true);
      }
    /**/

    var pushStateEl = d.getElementById('_pushState');
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>


<!--<![endif]-->
  



<div hidden>
  
  <h2 class="sr-only">Templates:</h2>

  <template id="_animation-template">
  <div class="animation-main fixed-top">
    <nav id="breadcrumbs" class="screen-only"><ul>
  
  
</ul></nav>
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

  <template id="_loading-template">
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

  <template id="_error-template">
  <div class="page">
    <h2 class="page-title">Error</h2>
    
    
    <p class="lead">
      Sorry, an error occurred while loading: <a class="this-link" href=""></a>.
    </p>
  </div>
</template>

  <template id="_permalink-template">
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="content-hash"></span>
  </a>
</template>

  
    <template id="_cookies-banner-template">
  <div id="_cookies-banner" class="navbar fixed-bottom CookiesOK">
    <div class="content">
      <div class="nav-btn-bar">
        <small class="faded">
          <span>This site uses cookies.
</span>
          <button id="_cookies-ok" class="btn btn-primary btn-sm">Okay</button>
        </small>
      </div>
    </div>
  </div>
</template>

  
  
    <template id="_dark-mode-template">
  <button id="_dark-mode" class="nav-btn no-hover" >
    <span class="sr-only">Dark Mode</span>
    <span class="icon-brightness-contrast"></span>
  </button>
</template>

  
  
    <template id="_search-template">
  <button id="_search" class="nav-btn no-hover">
    <label class="sr-only" for="_search-input">Search</label>
    <span class="icon-search"></span>
  </button>
  <div id="_search-box">
    <div class="nav-btn">
      <span class="icon-search"></span>
    </div>
    <input
      id="_search-input"
      type="search"
      class="form-control form-control-lg nav-btn"
      placeholder="Build with JEKYLL_ENV=production to enable search."
    />
    <button type="reset" class="nav-btn no-hover">
      <span class="sr-only">Close</span>
      <span class="icon-cross"></span>
    </button>
  </div>
  <div id="_hits"></div>
</template>

  
</div>


</body>
</html>
